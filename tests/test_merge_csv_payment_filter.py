from wage.settle_person import settle_person


def test_merge_csv_filters_attendance_rows_from_payment_checks() -> None:
    combined_rows = [
        {
            "日期": "2025-11-01",
            "实际出勤人员": "王怀宇",
            "今天是否施工": "是",
            "车辆": "防撞车",
            "报销日期": "",
            "报销金额": "",
            "报销状态": "",
            "报销类型": "",
            "报销人员": "",
            "项目": "",
            "上传凭证": "",
            "备注": "",
        },
        {
            "日期": "2025-11-02",
            "实际出勤人员": "王怀宇",
            "今天是否施工": "否",
            "车辆": "防撞车",
            "报销日期": "",
            "报销金额": "",
            "报销状态": "",
            "报销类型": "",
            "报销人员": "",
            "项目": "",
            "上传凭证": "",
            "备注": "",
        },
        {
            "日期": "",
            "实际出勤人员": "",
            "今天是否施工": "",
            "车辆": "",
            "报销日期": "2025-11-03",
            "报销金额": "1,500元",
            "报销状态": "已支付",
            "报销类型": "工资",
            "报销人员": "王怀宇",
            "项目": "测试项目",
            "上传凭证": "V-100",
            "备注": "工资",
        },
        {
            "日期": "",
            "实际出勤人员": "",
            "今天是否施工": "",
            "车辆": "",
            "报销日期": "2025-11-04",
            "报销金额": "",
            "报销状态": "已支付",
            "报销类型": "工资",
            "报销人员": "王怀宇",
            "项目": "测试项目",
            "上传凭证": "",
            "备注": "疑似支付行",
        },
    ]

    output = settle_person(
        combined_rows,
        combined_rows,
        person_name="王怀宇",
        role="组长",
        project_ended=True,
        project_name="测试项目",
        runtime_overrides={},
    )

    assert "【阻断｜工资结算】" not in output
    assert "已付合计：1500" in output
    assert "待确认汇总：金额缺失1条" in output
    assert "疑似支付行但金额缺失" not in output
