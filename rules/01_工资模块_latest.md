# 01_工资模块（v2025-09-17R7-HF2）
版本：v2025-09-17R7-HF2  
生效：2025-09-17  
打印版本：v2025-09-17R7-HF2

## 与 R7 差异更新（Delta）
- 预支抵扣范围：由“仅抵工资”→ **可抵工资+餐补+路补** 的合计。  
- 当期应付：**允许为负**；须在结算清单中**显著提示**“当期应付为负：员工需返还或下期冲减｜负值金额：¥N”。  
- 逐笔预支：结算清单中**逐笔列示**并计算合计（无则固定展示“无，−¥0”）。  
- 其他口径、强校验、审计留痕保持不变。

## 角色与单价
- 组长 300/天；组员 200/天。

## 名词与计薪口径（硬规则）
- 有效施工天：去重后的“施工”日期数（同日多条仅记 1 天；若同日出现“施工/未施工”，以施工优先）。  
- 工资天：= 有效施工天；未施工/休息/停工 **不计工资**。  
- 未施工天：去重后的“未施工”日期数，仅计餐补，不计工资。  
- 工资 = 角色单价 × 工资天。  
- 餐补 = 25 × 施工天 + 40 × 未施工天。  
- 路补 = 项目制一次性；仅“项目已结束=是”计入；封顶 200/人/项目。

## 计付时点（场景化）
- 场景 A：项目未结束 + 结清离场=是  
  → 当期应付 = (工资 + 餐补 + 路补) − 预支合计。  
- 场景 B：项目未结束 + 未离场  
  → 当期应付 = (工资 + 餐补 + 路补) − 预支合计；餐补“计提未支付”的管理属性不影响抵扣口径（可能出现负值）。  
- 场景 C：项目已结束  
  → 当期应付 = (工资 + 餐补 + 路补) − 预支合计。  

> **允许负值**：当期应付可为负；须在结算清单中强提示“当期应付为负：员工需返还或下期冲减｜负值金额：¥N”。

## 输出结构（呈现顺序）
- 默认 `Feature.Layout_SettlementLast = on`：  
  **结论 → 计算口径 → 已付/预支明细 → 校验摘要 → 差异与待补字段 → 结算清单（收尾）**。  
- 关闭该开关时回兼容旧版顺序，不影响数值。

## 强制校验（防呆阻断）
1) 若【工资天 ≠ 施工天】或存在【未施工日期被计入工资】→ **报错并拒绝出数**，并回显冲突日期清单。  
2) 同日多状态冲突 → 以“施工”为准，同日仅记 1 天，并记录处理日志。  
3) 任何“把报销记录当施工天”行为 → 阻断并红字提示。  
4) 预支明细命中但因风控未通过 → 不计入抵扣，**黄线提示原因**与证据行。  
5) 当期应付 < 0 → **必须输出强提示行**（见“结算清单模板”），否则拒绝出数。

## 状态词典与同义映射
- 允许值：{施工, 未施工, 休息, 请假, 停工}  
- 同义：施工 ← {干活, 上工, 加班(施工)}；未施工 ← {待命, 备勤, 现场未作业}  
- 白名单外状态 → 黄线预警。

## 出数页首“口径卡片”（固定回显，不可手改）
- 规则版本号 / 生效日 / 口径摘要 / 来源（source：pages/cdn/raw/tag/offline）  
- 诊断：`content-type / etag`（仅展示）  
- 若发生 MD↔TXT 降级或恢复：附 `MD_DG_AT / MD_DG_REASON / MD_HOLD 剩余`（display only）

## 工资天计算（保持 R6-HF2 口径）
- **工资天=施工天（去重，按自然日）**。未施工/休息/停工/报销均不得计入工资天。  
- **施工判定唯一依据**：`今天是否施工 ∈ {是, Y, 1, TRUE}` **且** `实际施工人员` 列表**包含该姓名**。  
- **同日冲突“施工优先”**：同一天既出现“施工=是”也出现“未施工/停工”，该人员当日记 **1 个施工天**、未施工天 **0**。  
- **未施工天**：仅当日**不存在**“施工=是 & 人员含该姓名”，且出现“未施工/停工”等有效记载时，记 **1**（用于餐补 `40×未施工天`）。  
- **报销排除**：`报销人员/费用类型/报销金额/用途` 等**一律不参与**施工与未施工的判定。  
- **姓名规范化**：去空格、去括注（如“（组长）”）、统一简繁；允许别名映射（如“刘凯/刘恺”）。  
- `实际施工人员` 为**多人列表**，分隔符支持 `,` `，` `、` `;` `；`，保存前先去空格与全半角差异。

## 预支识别与抵扣口径（HF2 更新）
**识别三要素（主口径）**：满足 **全部** 条件的报销行计为“预支”，可用于抵扣：  
1）报销类型 ∈ {`工资(付款或微信文字截图)`}；  
2）报销说明包含关键词：`预支｜借支｜预发`（大小写不敏感）；  
3）报销人员 == 结算对象姓名（忽略全/半角空格与括注）。  

**映射层（可选，默认关闭）**：  
- 将以下常见表述映射为“预支”（仍需通过风控）：`申请工资…｜申请…天工资…｜发工资…｜工资…元｜领工资…｜借工资…`  
- **反向黑名单（永不当预支）**：说明命中 `结算清单｜当期应付｜结清｜尾款｜补发｜绩效` → 一律视为**历史发薪**，不做预支抵扣。

**风控条件（全部满足）**：  
- 报销人员=本人（姓名规范化后匹配）；  
- 凭证日期处于**项目执行期**；  
- 报销状态=**已报销**；  
- 金额不与餐/路交叉（若说明含餐/路，则**不纳入预支**）。

**抵扣规则（HF2）**：  
- 设 `W=工资`，`M=餐补`，`R=路补`，`P=当期匹配预支合计`；  
- **当期应付 = (W + M + R) − P**（**允许为负**）；  
- **预支抵扣合计 = P**（不封顶）；  
- **出现负值**时必须在结算清单中输出：  
  `【当期应付为负：员工需返还或下期冲减｜负值金额：¥|Payable|】`。

**填写建议**：一人一笔一行；日期 `YYYY-MM-DD`；金额为正值。若为冲销，请使用“结清/冲减”字样且**不要带“预支”**。

## 审计与强校验（保持并补充）
- **强拦截 A**：发现某日把“报销记录”当“施工天”计入 → 阻断并红字提示。  
- **强拦截 B**：同日已判为“施工=是”，仍额外计入未施工天 → 阻断并红字提示。  
- **黄线提醒**：当期“报销记录占比>70% 且 施工天=0” → 仅提示，不阻断。  
- **审计留痕**：为每个记入的施工天输出 `date, worker, evidence_row_ids`；为每笔预支输出 `date, description, voucher_id, amount`。  
- **负值提醒**：`当期应付 < 0` 必须输出提示行（见模板）；否则拒绝出数并回显原因。  

## 输出规范：结算清单格式（固定展示，默认开启）
- 扣减金额与分隔线使用 **数学减号 U+2212 “−”**（而非 ASCII `-`）。  
- “预支抵扣（逐笔）”区：  
  - 有预支：逐笔列示 `- YYYY-MM-DD 说明（凭证#ID；金额=¥X） −¥X`；  
  - 无预支：固定输出 `无，**−¥0**`。  
- “当期应付”行：若为负，下一行**必须**追加  
  `【当期应付为负：员工需返还或下期冲减｜负值金额：¥N】`。  

## 实现参考（伪代码｜HF2）
    # 施工/未施工天判定同 R7，此处略
    W = unit_price(role) * days_work
    M = 25 * days_work + 40 * days_nonwork
    R = project_finished ? min(road_allowance_claimed, 200) : 0

    # 预支识别（主口径+映射层+风控）
    def is_prepay_main(r):
        return (r.type in {"工资(付款或微信文字截图)"} and
                contains_any(r.note, {"预支","借支","预发"}) and
                normalize(r.person) == normalize(worker.name))

    def is_prepay_mapped(r):
        if not Feature.Prepay_Mapping: return False
        if contains_any(r.note, {"结算清单","当期应付","结清","尾款","补发","绩效"}): return False
        return (r.type in {"工资(付款或微信文字截图)"} and
                contains_any(r.note, {"申请工资","申请","发工资","工资","领工资","借工资"}) and
                normalize(r.person) == normalize(worker.name) and
                r.date in project_period and r.status == "已报销" and
                not contains_any(r.note, {"餐","路"}))

    P = sum(amount for r in reimbursements if is_prepay_main(r) or is_prepay_mapped(r))
    D = P                         # 抵扣合计（不封顶）
    Payable = (W + M + R) - D     # 允许为负；负值需显著提示

## 结算清单模板（固定收尾）
结算清单｜{姓名}（{角色}）  
口径：{场景摘要；路补={R或0}；命中“预支”，抵扣工资+餐补+路补（允许为负）}

工资：{单价}×{施工天} = {W}  
餐补：25×{施工天} + 40×{未施工天} = {M}  
路补：{R}

预支抵扣（逐笔）：  
{若有：- {YYYY-MM-DD} {说明/关键词}（凭证{编号}；金额=¥{ai}） −¥{ai}}  
{若无：无，−¥0}  
预支抵扣合计：−¥{P}

───────────────────────  
当期应付：{W} + {M} + {R} + （−{P}） = {Payable}  
{若 Payable<0：下一行必须追加}  
【当期应付为负：员工需返还或下期冲减｜负值金额：¥{−Payable}】

日期明细  
施工日（计薪，{施工天}天）：{yyyy-mm-dd，…}  
未施工日（计餐补40/天，{未施工天}天）：{yyyy-mm-dd，…}

备注：预支识别=类型“工资(付款或微信文字截图)”∧说明含〔预支/借支/预发〕∧报销人员=本人（映射层需过风控）。

## 自检（失败即拒绝出数）
- 存在“当期应付：数字”；  
- 存在一行仅含 **U+2212 “−”**（分隔线）；  
- 结算清单为**最后一段**且非空；  
- 预支存在时，必须有“预支抵扣（逐笔）”列表与“预支抵扣合计：−¥X”；无预支时必须输出 “无，−¥0”。

## 结算清单尾行（固定展示，默认开启）
- 分隔线使用**数学减号 U+2212**（而非 ASCII `-`）。示例：  
  −−−−−−−−−−−−−−−−−−−−−−−  
- “预支抵扣”与所有扣减展示使用 **U+2212 “−”** 号：  
  预支抵扣合计 … **−¥Z**
−
