# CHANGELOG（只记录差异）
- 2026-01-05：工资模块升级 **v2026-01-05R71**
  - 兼容 2026 项目池新表字段映射：报销表新增报销说明列；施工表新增出勤模式列与人员回落列。
  - 出勤模式判定升级：模式列含“单防撞”即单防撞，否则全组；单防撞不再依赖车辆字段。
  - 出勤人员拆分增强：支持分号/换行拆分，多人同格去重展开。
- 2025-11-25：工资模块升级 **v2025-11-25R70**
  - PaymentPipe 计入口径收紧：仅类型/科目/类别包含“工资”才计入已付/预支。
  - 支付候选行类型必填，缺失即 Hard 阻断并输出行号与证据；备注关键词不再触发计入。
- 2025-11-25：工资模块升级 **v2025-11-25R69**
  - PaymentPipe 口径改为 wage-only，仅识别工资/工资预支。
  - 非工资类报销不再进入待确认、不参与凭证唯一/金额校验，避免干扰工资单。
- 2025-11-25：工资模块升级 **v2025-11-25R68**
  - 路补改为固定 200 元/人/项目：仅项目已结束且路补口令=计算路补时计入。
  - 路补金额计算不再依赖支付记录中的路补/顺风车/拼车等明细。
- 2025-11-25：工资模块升级 **v2025-11-25R67**
  - PaymentPipe 增加出勤行护栏，命中是否施工或施工日期+人员直接跳过。
  - 支付候选行锚点改为金额/凭证/类别/状态/结果之一（备注不再单独触发）。
  - 类别无法识别统一进入待确认（原因=类别待确认），不阻断出单。
- 2025-11-25：工资模块升级 **v2025-11-25R66**
  - 报销状态为空且结果=通过时，待确认原因改为“通过但状态缺失”，不再触发阻断。
  - 报销状态无效/缺失/结果未通过统一进入待确认汇总（不计入已付/预支）并继续出单。
  - schema 层不对状态值做枚举拦截，状态为空/任意字符串仍可进入待确认判定。
- 2025-11-25：工资模块升级 **v2025-11-25R65**
  - 合并表同时存在报销状态与报销结果时，结果通过/未通过均归入待确认，不再触发阻断。
  - 待确认原因新增已通过未支付/未通过，并在单人汇总与批量汇总按原因统计。
  - schema 层不对状态值做枚举拦截，状态为空/任意字符串仍进入待确认判定。
- 2025-11-25：工资模块升级 **v2025-11-25R64**
  - PaymentPipe 状态缺失/无效不再阻断：进入待确认汇总，默认仅汇总，明细写入日志。
  - 待确认原因细分状态缺失/状态无效/类别待确认/金额缺失，批量汇总索引按原因统计人数与条数。
  - 状态白名单确认“已报销”计入已付/预支。
- 2025-11-25：工资模块升级 **v2025-11-25R63**
  - PaymentPipe 状态无效不再阻断：进入待确认清单，不计入已付/预支。
  - 详细版新增待确认清单明细（含行号/状态/金额/凭证/备注），批量汇总索引统计待确认人数与条数。
- 2025-11-25：工资模块升级 **v2025-11-25R62**
  - 批量口令解析支持去 BOM、全角冒号/等号归一化，项目结算首行解析项目名。
  - 顶层键值行支持项目结束/路补口令/项目覆盖解析。
- 2025-11-25：工资模块升级 **v2025-11-25R61**
  - 新增项目结算批量出单（汇总索引、阻断原因、固定日薪/角色来源回显）。
  - 口令支持角色/固定日薪区块，锁定角色与日薪优先级。
  - 批量出单要求项目已结束=是，否则 Hard 阻断。
- 2025-11-25：工资模块升级 **v2025-11-25R60**
  - 压缩版工资/餐补/应付补齐公式，应付公式固定五项并保留零值项。
  - 日期（模式→出勤）改为逐日列出，不再按月折叠。
- 2025-11-25：工资模块升级 **v2025-11-25R59**
  - run_id 每次运行唯一；日志文件名改为 logs/{run_id}_{hash8}.json 避免覆盖。
  - data/当前/配置.txt 新增 show_notes/show_checks/show_audit 开关（默认 1）。
- 2025-11-25：工资模块升级 **v2025-11-25R58**
  - 默认 verbose=0：终端正文仅保留 run_id + 规则版本并追加日志路径，清洗日志/审计明细移至日志文件。
  - input_hash/output_hash、校核证据、待确认明细统一写入 logs/{run_id}.json；verbose=1 才在正文展示。
- 2025-11-25：工资模块升级 **v2025-11-25R57**
  - 详细版抬头补充项目结束/路补口令/来源信息，并追加日期（模式→出勤）分组。
  - 压缩版补齐日期（模式→出勤）与工资/路补展示格式。
  - 默认正文移除 logs/待确认汇总/差异清单汇总等调试提示，仅在 verbose 或日志中保留。
  - 路补金额展示为数值，不再打印 min(...) 公式。
- 2025-11-25：工资模块升级 **v2025-11-25R56**
  - 修正合并表按人统计口径：仅统计目标人出现日期，不再推断未出勤。
  - 餐补按 25×施工天 + 40×未施工天启用（仅全组参与）。
  - 路补按项目已结束且路补记录存在时启用，封顶 200。
  - 支付科目新增路补识别，油费/ETC 仍归项目费用。
- 2025-11-25：工资模块升级 **v2025-11-25R55**
  - 支付候选行过滤仅基于金额/类型/状态/凭证/备注字段，纯出勤行不再误触校验。
  - 候选行金额缺失不再硬阻断，进入待确认并留证据。
- 2025-11-25：工资模块升级 **v2025-11-25R54**
  - 扩展考勤表头映射（姓名/是否施工别名），支持同格多人拆分并留审计。
  - 合并表兼容：空日期行跳过，避免支付行误判日期异常。
  - 支付表过滤：空金额且类型/状态/凭证/备注皆空 → 视为非支付行跳过。
  - 金额解析增强：允许￥/元/逗号/空格，失败才阻断并记录原值与行号。
  - 项目名兜底：文件名去除 _数据表_数据/_表格/_问卷/_收集结果 等后缀。
- 2025-11-25：工资模块升级 **v2025-11-25R53**
  - 日薪调整为角色优先（组长300/组员200）+姓名映射覆盖。
  - 餐补/路补口径调整为 0（仍在模板中展示）。
- 2025-11-25：工资模块升级 **v2025-11-25R52**（按人出单最小可用）
  - 新增按人出单双版本输出（详细版/压缩版），阻断模式 Hard，校核≥10项与审计留痕。
  - 固化 AttendancePipe/PaymentPipe 双管道隔离，按“项目×日期”模式收口与凭证唯一校验。
  - 强化 schema 校验：缺字段/格式异常/项目不匹配/状态无效 → 阻断并输出修复建议。
- 2025-09-15：工资模块升级 **v2025-09-15R6**（离场口径）
  - 规则：若人员标记为“结清离场”，**当期结清其个人餐补**；路补仍按“项目未结束＝0”不结。
  - 适用范围：该员工在该项目的离场当期及之前统计周期；后续月份不再为该项目计提餐补。
  - 兼容与优先级：同日“施工/未施工”仍遵循“施工优先、同日去重”；“清障”日餐补=0 的规则不变；预支与有效状态校验不变。
  - 审计：模板打印模块版本号 `v2025-09-15R6` 和“离场即结餐补”变更说明，并生成差异清单（旧口径R5 vs 新口径R6）。
- 2025-09-15：工资模块升级 v2025-09-15R5；修正“结清离场=未结束（路补=0，餐补当期计入）”；固化班别映射与“施工优先/同日去重”。
- 2025-09-15：工资模块升级 v2025-09-15R4；新增“结清离场=未结束；当期路补=0；餐补照算；关键词识别与拦截”。
- 2025-09-15：整理 CHANGELOG；删除占位示例行并统一标题格式（仅文本规范化，不改规则内容）。
- 2025-09-02：初始化规则库（新增 rules/01~04）；工资模块定版 v2025-09-02R3；新增“报销有效状态口径、未结束路补=0、模板含本期小计/待项目结束结算项”。
## v2025-09-15R6-HF4（2025-09-15）

### 新增
- 结算清单尾行固定展示：工资 + 餐补 + 路补 − 预支 = 当前应付金额。
- 新增“预支来源”默认展示（仅计入“已报销”且当期计入，且不超过当期工资）。

### 变更
- 同步 `rules/01_工资模块_latest.md` = v2025-09-15R6-HF4。
- 更新 `rules/README.md` 规则索引，当前生效版本指向 v2025-09-15R6-HF4。

> 备注：尾行中的减号为**数学减号**“−”，非短横“-”。
