# 01_工资模块（v2025-11-25R52）
版本 v2025-11-25R52
生效：2025-11-25
打印版本 v2025-11-25R52

## 变更说明（R52）
- 口径切换为“按人出单”最小可用版，输出双版本（详细版/压缩版）。
- 新增“双管道隔离”：AttendancePipe 与 PaymentPipe 互不读取对方字段。
- 强化阻断规则：schema 缺失、项目不匹配、状态无效、凭证重复均直接阻断。
- 固化校核与审计：校核≥10项、审计留痕包含 run_id / input_hash / output_hash。

## 输入与识别
- 输入仅允许两张表：施工表、支付记录表。
- 必填字段（施工表）：日期、姓名、是否施工（车辆字段用于单防撞审计）。
- 必填字段（支付表）：日期、金额、状态、类型、姓名、项目、凭证。
- 项目名识别：口令含“项目=XXX”优先；否则由 CSV 文件名去扩展与常见后缀兜底。
- 同日冲突：同人同日“施工/未施工”冲突，施工优先并记录审计。

## AttendancePipe（考勤/模式/日期集合）
- 模式收口（项目×日期）：
  - N_work=当日“是否施工=是”的去重人数。
  - 1<=N_work<=2 → 单防撞；N_work>=3 → 全组；N_work=0 → 全组。
- 输出四类日期集合（仅该人）：
  - 单防撞｜出勤、单防撞｜未出勤、全组｜出勤、全组｜未出勤。

## PaymentPipe（支付/预支/状态/凭证）
- 状态白名单：已支付/已转账/已报销/完成/通过/成功/已结清/OK/已打款/审核通过。
- 仅按“姓名+项目”归集合计（不按日期过滤）。
- 类别分流（最小可用）：
  - 工资/预支/餐补(伙食/盒饭/工作餐) → 计入个人已付/预支。
  - 路费类 → 项目费用；无效状态 → 待确认。
- 凭证唯一：voucher|TEMP + 日期 + 金额 唯一；voucher 空且五元组重复 → 阻断。

## 计价（最小可用）
- 固定日薪映射：
  - 王怀宇300；余步云260；董峰300；董祥300；王怀良230；袁玉兵300。
- 全组工资：D_group * 全组出勤天数；全组未出勤工资=0。
- 单防撞工资：D_single_yes 默认270；D_single_no=round(0.5*D_single_yes)=135。
- 餐补：仅全组参与；全组出勤25/天，全组未出勤40/天；单防撞餐补恒0。
- 路补：仅项目已结束计入；默认0（骨架口径）。
- 应付=工资+餐补+路补-已付/预支（允许为负并提示负值金额）。

## 输出模板（固定行文）
- 输出两段纯文字（中间空行）：
  ① 详细版（给杰对账）含金额公式、已付/预支合计、校核摘要、版本尾注。
  ② 压缩版（发员工）0值整段隐藏。
- 详细版文末追加“日期（模式→出勤）”四类分组，空类不打印。
- 版本尾注固定：计算口径版本 v2025-11-25R52｜阻断模式：Hard。

## 校核（≥10项）
- A 表头映射成功；B 项目名确定；C 凭证唯一；D 出勤冲突消解；E 应付反算一致；
  F 模式不混合；G 金额数值化；H 两版日期集合一致；M 单防撞必要字段满足；
  P 待确认条数提示；V 版本尾注存在；S schema 校验。

## 审计留痕
- run_id（由 input_hash 生成）、规则版本、输入 hash、输出 hash。
- 自动纠错必须记录前后值与触发规则。
